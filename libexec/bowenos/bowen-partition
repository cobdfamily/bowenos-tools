#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=../../lib/bowenos/includes/common.sh
source "${SCRIPT_DIR}/../../lib/bowenos/includes/common.sh"

if [[ -d /tmp/bowenos ]]; then
  INVENTORY_ROOT="/tmp/bowenos"
fi
select_host_if_needed
if [[ -z "${HOST}" ]]; then
  echo "HOST could not be determined for disko." >&2
  exit 2
fi
if [[ -n "${HOST}" ]]; then
  TARGET="$(nix eval --raw "path:${INVENTORY_ROOT}#hostInfo.${HOST}.target")"
  BOOTA_BYID="$(nix eval --raw "path:${INVENTORY_ROOT}#hosts.${HOST}.bootaById")"
  BOOTB_BYID="$(nix eval --raw "path:${INVENTORY_ROOT}#hosts.${HOST}.bootbById")"
  DISK_MODE="$(nix eval --raw "path:${INVENTORY_ROOT}#hostInfo.${HOST}.diskMode")"
  BOOT_MODE="$(nix eval --raw "path:${INVENTORY_ROOT}#hostInfo.${HOST}.bootMode")"
  DISK_PATH="${ROOT}/targets/${TARGET}/disks.nix"
fi
export BOOTA_BYID BOOTB_BYID DISK_MODE BOOT_MODE
if [[ -z "${BOOTA_BYID:-}" || -z "${BOOTB_BYID:-}" ]]; then
  echo "Set bootaById/bootbById in hosts/${HOST}/local.nix." >&2
  exit 2
fi
if [[ "${FORCE:-0}" != "1" ]]; then
  echo "⚠️  About to WIPE and repartition:"
  echo "    BOOTA_BYID=${BOOTA_BYID}"
  echo "    BOOTB_BYID=${BOOTB_BYID}"
  read -r -p "Continue? (y/N) " ans
  case "${ans}" in
    [yY]|[yY][eE][sS]) ;;
    *) echo "Aborted."; exit 1 ;;
  esac
fi
nix --extra-experimental-features "nix-command flakes" run --impure \
  github:nix-community/disko -- \
  --mode disko ${DISK_PATH}

echo
echo "Post-disko validation:"
if command -v zpool >/dev/null 2>&1; then
  zpool import -N rpool >/dev/null 2>&1 || true
  zpool get -H bootfs rpool || true
  zfs list -r rpool || true
else
  echo "  zpool not found; skipping ZFS validation."
fi
