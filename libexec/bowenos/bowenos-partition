#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=../../lib/bowenos/includes/common.sh
source "${SCRIPT_DIR}/../../lib/bowenos/includes/common.sh"

INVENTORY_ROOT="/tmp/bowenos"
require_command git
require_command nix
if [[ ! -d "${INVENTORY_ROOT}" ]]; then
  echo "Missing ${INVENTORY_ROOT}. Run bowenos setup first." >&2
  exit 2
fi
if [[ ! -d "${INVENTORY_ROOT}/hosts" ]]; then
  echo "Missing ${INVENTORY_ROOT}/hosts. Run bowenos setup first." >&2
  exit 2
fi

select_host_from_inventory "${INVENTORY_ROOT}"

if [[ -z "${HOST}" ]]; then
  echo "HOST could not be determined for partitioning." >&2
  exit 2
fi
load_target_from_inventory "${INVENTORY_ROOT}" "${HOST}"
BOOTA_BYID="$(nix_eval_raw "path:${INVENTORY_ROOT}#hosts.${HOST}.bootaById")"
BOOTB_BYID="$(nix_eval_raw "path:${INVENTORY_ROOT}#hosts.${HOST}.bootbById")"
DISK_MODE="$(nix_eval_raw "path:${INVENTORY_ROOT}#hostInfo.${HOST}.diskMode")"
BOOT_MODE="$(nix_eval_raw "path:${INVENTORY_ROOT}#hostInfo.${HOST}.bootMode")"
validate_disk_mode "${DISK_MODE}" "hosts/${HOST}/local.nix"
validate_boot_mode "${BOOT_MODE}" "hosts/${HOST}/local.nix"
export BOOTA_BYID BOOTB_BYID DISK_MODE BOOT_MODE
if [[ -z "${BOOTA_BYID:-}" ]]; then
  echo "Set bootaById in hosts/${HOST}/local.nix." >&2
  exit 2
fi
if [[ "${DISK_MODE:-mirror}" == "mirror" && -z "${BOOTB_BYID:-}" ]]; then
  echo "Set bootbById in hosts/${HOST}/local.nix for mirror mode." >&2
  exit 2
fi
PARTITION_ROOT="/tmp/bowenos-partitioning"
PARTITION_REPO="${BOWENOS_PARTITION_REPO:-https://github.com/cobdfamily/bowenos}"
if [[ "${FORCE:-0}" != "1" ]]; then
  echo "⚠️  About to WIPE and repartition:"
  echo "    TARGET=${TARGET}"
  echo "    DISK_MODE=${DISK_MODE}"
  echo "    BOOTA_BYID=${BOOTA_BYID}"
  if [[ "${DISK_MODE}" == "mirror" ]]; then
    echo "    BOOTB_BYID=${BOOTB_BYID}"
  fi
  read -r -p "Continue? (y/N) " ans
  case "${ans}" in
    [yY]|[yY][eE][sS]) ;;
    *) echo "Aborted."; exit 1 ;;
  esac
else
  echo "FORCE=1 set; skipping confirmation prompt."
fi
${RM} -rf "${PARTITION_ROOT}"
if ! git clone --depth 1 --single-branch "${PARTITION_REPO}" "${PARTITION_ROOT}"; then
  echo "Failed to fetch bowenos partition sources from GitHub." >&2
  exit 2
fi

DISK_PATH="${PARTITION_ROOT}/targets/${TARGET}/disks.nix"
if [[ ! -f "${DISK_PATH}" ]]; then
  echo "Could not find disk file for target '${TARGET}': ${DISK_PATH}" >&2
  exit 2
fi
echo "Partitioning with Disko..."
nix_run --impure \
  --refresh \
  github:nix-community/disko -- \
  --mode disko "${DISK_PATH}"

echo
echo "Post-partition validation:"
if command -v zpool >/dev/null 2>&1; then
  zpool import -N rpool >/dev/null 2>&1 || true
  zpool get -H bootfs rpool || true
  zfs list -r rpool || true
else
  echo "  zpool not found; skipping ZFS validation."
fi
