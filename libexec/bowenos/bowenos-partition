#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=../../lib/bowenos/includes/common.sh
source "${SCRIPT_DIR}/../../lib/bowenos/includes/common.sh"

INVENTORY_ROOT="/tmp/bowenos"
if [[ ! -d "${INVENTORY_ROOT}" ]]; then
  echo "Missing ${INVENTORY_ROOT}. Run bowenos setup first." >&2
  exit 2
fi
if [[ ! -d "${INVENTORY_ROOT}/hosts" ]]; then
  echo "Missing ${INVENTORY_ROOT}/hosts." >&2
  exit 2
fi

if [[ -z "${HOST}" ]]; then
  mapfile -t _hosts < <(find "${INVENTORY_ROOT}/hosts" -mindepth 1 -maxdepth 1 -type d -printf "%f\n" | sort)
  if [[ ${#_hosts[@]} -eq 0 ]]; then
    echo "No hosts found under ${INVENTORY_ROOT}/hosts." >&2
    exit 2
  fi
  if [[ ${#_hosts[@]} -eq 1 ]]; then
    HOST="${_hosts[0]}"
  else
    echo "HOST is not set. Select a host:"
    i=1
    for h in "${_hosts[@]}"; do
      echo "  ${i}) ${h}"
      i=$((i + 1))
    done
    read -r -p "Select host number: " idx
    if [[ "${idx}" =~ ^[0-9]+$ ]] && (( idx >= 1 && idx <= ${#_hosts[@]} )); then
      HOST="${_hosts[$((idx-1))]}"
    else
      echo "Invalid selection." >&2
      exit 2
    fi
  fi
fi

if [[ -z "${HOST}" ]]; then
  echo "HOST could not be determined for disko." >&2
  exit 2
fi
if [[ -n "${HOST}" ]]; then
  TARGET="$(nix eval --raw "path:${INVENTORY_ROOT}#hostInfo.${HOST}.target")"
  BOOTA_BYID="$(nix eval --raw "path:${INVENTORY_ROOT}#hosts.${HOST}.bootaById")"
  BOOTB_BYID="$(nix eval --raw "path:${INVENTORY_ROOT}#hosts.${HOST}.bootbById")"
  DISK_MODE="$(nix eval --raw "path:${INVENTORY_ROOT}#hostInfo.${HOST}.diskMode")"
  BOOT_MODE="$(nix eval --raw "path:${INVENTORY_ROOT}#hostInfo.${HOST}.bootMode")"
  PARTITION_ROOT="/tmp/bowenos-partitioning"
  PARTITION_REPO="https://github.com/cobdfamily/bowenos"

  ${RM} -rf "${PARTITION_ROOT}"
  git clone --depth 1 "${PARTITION_REPO}" "${PARTITION_ROOT}"

  DISK_PATH="${PARTITION_ROOT}/targets/${TARGET}/disks.nix"
  if [[ ! -f "${DISK_PATH}" ]]; then
    echo "Could not find disk file for target '${TARGET}': ${DISK_PATH}" >&2
    exit 2
  fi
fi
export BOOTA_BYID BOOTB_BYID DISK_MODE BOOT_MODE
if [[ -z "${BOOTA_BYID:-}" || -z "${BOOTB_BYID:-}" ]]; then
  echo "Set bootaById/bootbById in hosts/${HOST}/local.nix." >&2
  exit 2
fi
if [[ "${FORCE:-0}" != "1" ]]; then
  echo "⚠️  About to WIPE and repartition:"
  echo "    BOOTA_BYID=${BOOTA_BYID}"
  echo "    BOOTB_BYID=${BOOTB_BYID}"
  read -r -p "Continue? (y/N) " ans
  case "${ans}" in
    [yY]|[yY][eE][sS]) ;;
    *) echo "Aborted."; exit 1 ;;
  esac
fi
nix --extra-experimental-features "nix-command flakes" run --impure \
  github:nix-community/disko -- \
  --mode disko ${DISK_PATH}

echo
echo "Post-disko validation:"
if command -v zpool >/dev/null 2>&1; then
  zpool import -N rpool >/dev/null 2>&1 || true
  zpool get -H bootfs rpool || true
  zfs list -r rpool || true
else
  echo "  zpool not found; skipping ZFS validation."
fi
