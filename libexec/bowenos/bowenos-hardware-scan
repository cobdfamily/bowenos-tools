#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=../../lib/bowenos/includes/common.sh
source "${SCRIPT_DIR}/../../lib/bowenos/includes/common.sh"

DEST_DIR="${1:-.}"
if [[ ! -d "${DEST_DIR}" ]]; then
  echo "Destination directory does not exist: ${DEST_DIR}" >&2
  exit 2
fi

require_command nixos-generate-config
require_command sync
tmp_root="/tmp/hardware"
cleanup() {
  ${RM} -rf "${tmp_root}"
}
trap cleanup EXIT
${RM} -rf "${tmp_root}"
${MKDIR} -p "${tmp_root}"
nixos-generate-config --root "${tmp_root}"
${CP} "${tmp_root}/etc/nixos/hardware-configuration.nix" "${DEST_DIR}/hardware-configuration.nix"
sync
echo "Wrote ${DEST_DIR}/hardware-configuration.nix"
