#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=../../lib/bowenos/includes/common.sh
source "${SCRIPT_DIR}/../../lib/bowenos/includes/common.sh"

read -r -p "Hostname: " HOSTNAME
if [[ -z "${HOSTNAME}" ]]; then
  echo "Hostname is required." >&2
  exit 2
fi

${RM} -rf /tmp/bowenos
${MKDIR} -p /tmp/bowenos

# Copy inventory flake
${CP} "${INVENTORY_ROOT}/flake.nix" /tmp/bowenos/flake.nix
if [[ -f "${INVENTORY_ROOT}/flake.lock" ]]; then
  ${CP} "${INVENTORY_ROOT}/flake.lock" /tmp/bowenos/flake.lock
fi

# Copy example host
${MKDIR} -p "/tmp/bowenos/hosts/${HOSTNAME}"
${CP} "${INVENTORY_ROOT}/hosts/example/local.nix" "/tmp/bowenos/hosts/${HOSTNAME}/local.nix"

# Disk mode
read -r -p "Disk mode (mirror/single) [mirror]: " DISK_MODE
DISK_MODE="${DISK_MODE:-mirror}"
if [[ "${DISK_MODE}" != "mirror" && "${DISK_MODE}" != "single" ]]; then
  echo "Invalid disk mode." >&2
  exit 2
fi
set_local_nix_value "/tmp/bowenos/hosts/${HOSTNAME}/local.nix" "diskMode" "\"${DISK_MODE}\""

# Boot mode
read -r -p "Boot mode (uefi/bios) [uefi]: " BOOT_MODE
BOOT_MODE="${BOOT_MODE:-uefi}"
if [[ "${BOOT_MODE}" != "uefi" && "${BOOT_MODE}" != "bios" ]]; then
  echo "Invalid boot mode." >&2
  exit 2
fi
set_local_nix_value "/tmp/bowenos/hosts/${HOSTNAME}/local.nix" "bootMode" "\"${BOOT_MODE}\""

# Admin user + SSH key
read -r -p "Admin username [admin]: " ADMIN_USER
ADMIN_USER="${ADMIN_USER:-admin}"
set_local_nix_value "/tmp/bowenos/hosts/${HOSTNAME}/local.nix" "adminUser" "\"${ADMIN_USER}\""

# Host identity
read -r -p "Host ID (8 hex chars) [deadbeef]: " HOST_ID
HOST_ID="${HOST_ID:-deadbeef}"
set_local_nix_value "/tmp/bowenos/hosts/${HOSTNAME}/local.nix" "hostId" "\"${HOST_ID}\""

read -r -p "Timezone [America/Vancouver]: " TIMEZONE
TIMEZONE="${TIMEZONE:-America/Vancouver}"
set_local_nix_value "/tmp/bowenos/hosts/${HOSTNAME}/local.nix" "timeZone" "\"${TIMEZONE}\""

read -r -p "Locale [en_CA.UTF-8]: " LOCALE
LOCALE="${LOCALE:-en_CA.UTF-8}"
set_local_nix_value "/tmp/bowenos/hosts/${HOSTNAME}/local.nix" "locale" "\"${LOCALE}\""

read -r -p "SSH public key: " SSH_KEY
if [[ -z "${SSH_KEY}" ]]; then
  echo "SSH public key is required." >&2
  exit 2
fi
set_local_nix_value "/tmp/bowenos/hosts/${HOSTNAME}/local.nix" "sshPubKey" "\"${SSH_KEY}\""
set_local_nix_value "/tmp/bowenos/hosts/${HOSTNAME}/local.nix" "allowNoKey" "false"
set_local_nix_value "/tmp/bowenos/hosts/${HOSTNAME}/local.nix" "sudoNeedsPassword" "false"
set_local_nix_value "/tmp/bowenos/hosts/${HOSTNAME}/local.nix" "mutableUsers" "false"

# Disk selection menu
mapfile -t disks < <(ls -1 /dev/disk/by-id | grep -v -- '-part' | sort -u)
if [[ ${#disks[@]} -eq 0 ]]; then
  echo "No disks found in /dev/disk/by-id." >&2
  exit 2
fi

selected=()
select_disk_by_id "Select BOOTA_BYID:" disks selected
if [[ "${DISK_MODE}" == "mirror" ]]; then
  select_disk_by_id "Select BOOTB_BYID:" disks selected
fi

set_local_nix_value "/tmp/bowenos/hosts/${HOSTNAME}/local.nix" "bootaById" "\"${selected[0]}\""
if [[ "${DISK_MODE}" == "mirror" ]]; then
  set_local_nix_value "/tmp/bowenos/hosts/${HOSTNAME}/local.nix" "bootbById" "\"${selected[1]}\""
else
  set_local_nix_value "/tmp/bowenos/hosts/${HOSTNAME}/local.nix" "bootbById" "\"\""
fi

# Hardware scan
${RM} -rf /tmp/hardware
${MKDIR} -p /tmp/hardware
nixos-generate-config --root /tmp/hardware
${CP} /tmp/hardware/etc/nixos/hardware-configuration.nix "/tmp/bowenos/hosts/${HOSTNAME}/hardware-configuration.nix"

echo "Inventory written to /tmp/bowenos/hosts/${HOSTNAME}"
