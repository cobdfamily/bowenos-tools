#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=../../lib/bowenos/includes/common.sh
source "${SCRIPT_DIR}/../../lib/bowenos/includes/common.sh"

DEST_DIR="${1:-.}"
if [[ ! -d "${DEST_DIR}" ]]; then
  echo "Destination directory does not exist: ${DEST_DIR}" >&2
  exit 2
fi

require_command nixos-generate-config
${RM} -rf /tmp/hardware
${MKDIR} -p /tmp/hardware
nixos-generate-config --root /tmp/hardware
${CP} /tmp/hardware/etc/nixos/hardware-configuration.nix "${DEST_DIR}/hardware-configuration.nix"
echo "Wrote ${DEST_DIR}/hardware-configuration.nix"
