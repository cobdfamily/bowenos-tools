#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=../../lib/bowenos/includes/common.sh
source "${SCRIPT_DIR}/../../lib/bowenos/includes/common.sh"

fail=0
shopt -s nullglob
for f in "${ROOT}"/modules/services/iscsi/targets/*.nix; do
  echo "Checking ${f}"
  paths="$(grep -oE 'backing[[:space:]]*=[[:space:]]*"[^"]+"' "${f}" | sed -E 's/.*"([^"]+)".*/\1/')"
  if [[ -z "${paths}" ]]; then
    echo "  (no backing paths found)"
    continue
  fi
  for p in ${paths}; do
    if [[ ! -e "${p}" ]]; then
      echo "  ❌ Missing: ${p}"
      fail=1
    else
      echo "  ✅ Found:   ${p}"
    fi
  done
done
exit ${fail}
