#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=../../lib/bowenos/includes/common.sh
source "${SCRIPT_DIR}/../../lib/bowenos/includes/common.sh"

${RM} -rf /tmp/hardware
${MKDIR} -p /tmp/hardware
nixos-generate-config --root /tmp/hardware
if [[ -n "${HOST}" ]]; then
  ${MKDIR} -p "${INVENTORY_ROOT}/hosts/${HOST}"
  ${CP} /tmp/hardware/etc/nixos/hardware-configuration.nix "${INVENTORY_ROOT}/hosts/${HOST}/hardware-configuration.nix"
  echo "Wrote ${INVENTORY_ROOT}/hosts/${HOST}/hardware-configuration.nix"
else
  ${CP} /tmp/hardware/etc/nixos/hardware-configuration.nix "${ROOT}/hardware-configuration.nix"
  echo "Wrote ${ROOT}/hardware-configuration.nix"
fi
