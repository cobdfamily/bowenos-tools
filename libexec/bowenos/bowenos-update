#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=../../lib/bowenos/includes/common.sh
source "${SCRIPT_DIR}/../../lib/bowenos/includes/common.sh"

if [[ -f /etc/bowenos/flake.nix ]]; then
  require_command nix
  require_command nixos-rebuild
  if [[ ! -f /etc/hostname ]]; then
    echo "Missing /etc/hostname; cannot determine current host for update." >&2
    exit 2
  fi
  HOST="$(cat /etc/hostname)"
  if [[ -z "${HOST}" ]]; then
    echo "Empty /etc/hostname; cannot determine current host for update." >&2
    exit 2
  fi
  load_target_from_inventory "/etc/bowenos" "${HOST}"
  ensure_mountpoint /boot "disk-bootA-esp"
  if [[ -e /dev/disk/by-partlabel/disk-bootB-esp ]]; then
    ensure_mountpoint /bootB "disk-bootB-esp"
  fi
  sudo nixos-rebuild switch --refresh --impure --flake "path:/etc/bowenos#${HOST}"
else
  echo "Missing /etc/bowenos/flake.nix. Ensure host config is present in /etc/bowenos." >&2
  exit 1
fi
