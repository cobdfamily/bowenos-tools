#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=../../lib/bowenos/includes/common.sh
source "${SCRIPT_DIR}/../../lib/bowenos/includes/common.sh"

if [[ -f /tmp/bowenos/flake.nix ]]; then
  select_host_from_inventory "/tmp/bowenos"
  load_target_from_inventory "/tmp/bowenos" "${HOST}"
  if ! mountpoint -q /mnt/persist; then
    echo "/mnt/persist is not mounted. Refusing to copy inventory into the live environment." >&2
    exit 2
  fi
  ${MKDIR} -p /mnt/persist/etc/bowenos
  ${CP} -a /tmp/bowenos/. /mnt/persist/etc/bowenos/
  nixos-install --refresh --impure --flake "path:/tmp/bowenos#${HOST}"
else
  echo "Missing /tmp/bowenos/flake.nix. Run bowenos setup first." >&2
  exit 2
fi
